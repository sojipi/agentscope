# 狼人游戏智能代理 (PlayerAgent) 介绍文档

## 概述

PlayerAgent 是一个基于 AgentScope 框架的高级狼人游戏智能代理，专为 9 人局无警长模式设计。该代理采用 ReAct (Reasoning and Acting) 架构，具备深度策略分析、角色扮演和自适应学习能力。

## 核心特性

### 1. 多角色智能支持

- **狼人 (Werewolf)**: 团队协作、夜间击杀策略、悍跳决策
- **预言家 (Seer)**: 查验逻辑、起跳时机、可信度评估
- **女巫 (Witch)**: 救人/毒杀决策、身份隐藏策略
- **猎人 (Hunter)**: 开枪时机、目标选择
- **村民 (Villager)**: 逻辑推理、投票分析、阵营选择

### 2. 高级策略引擎

- **位置学分析**: 根据发言位置(前位/中位/后位)调整策略
- **投票模式识别**: 检测狼队协调投票、互投模式
- **可信度评估**: 多维度评估预言家声明可信度
- **反注入攻击**: 识别并防御提示注入攻击

### 3. 状态管理与学习

- **游戏状态追踪**: 实时更新角色、存活状态、投票历史
- **经验记录**: 自动记录游戏经验用于后续分析
- **怀疑度系统**: 动态评估玩家可疑程度
- **角色声明管理**: 跟踪所有玩家的角色声明

## 技术架构

### 基础架构

```python
class PlayerAgent(ReActAgent):
    """狼人游戏玩家代理"""

    def __init__(self, name: str) -> None:
        super().__init__(
            name=name,
            sys_prompt=self._build_sys_prompt(name),
            model=DashScopeChatModel(
                api_key=os.environ.get("DASHSCOPE_API_KEY"),
                model_name="qwen3-max",
                stream=False,  # 非流式更适合策略思考
                generate_kwargs={
                    "temperature": 0.7,          # 适度创造性，避免过于死板
                    "top_p": 0.9,                # 保持词汇多样性
                    # 移除 stop: "\n\n" 会截断多段落发言
                    # 移除 presence/frequency_penalty: DashScope 不支持
                }
            ),
            formatter=DashScopeMultiAgentFormatter(),
        )
```

### 核心组件

#### 1. 系统提示构建 (`_build_sys_prompt`)

- 包含完整的 9 人局无警长规则
- 各角色的详细策略指导
- 位置学策略分析
- 安全警告和反注入规则

#### 2. 游戏信息提取 (`_extract_game_info`)

- 角色识别(中英双语支持)
- 队友识别(狼人专用)
- 死亡信息追踪
- 投票历史记录
- 角色声明管理

#### 3. 策略上下文构建 (`_build_context`)

- 当前游戏状态概览
- 已知角色信息
- 怀疑度排名
- 投票模式分析
- 阶段性策略建议

#### 4. 可信度评估 (`_evaluate_seer_credibility`)

- 对跳情况分析
- 查验结果验证
- 起跳位置评估
- 交叉查杀检测

## 游戏策略

### 狼人策略

- **夜间击杀**: 优先击杀预言家，考虑自刀策略
- **悍跳决策**: 基于位置和队友分布决定是否悍跳
- **团队协作**: 双狼踩一狼、深水狼策略
- **投票分裂**: 避免全队投票同一目标

### 预言家策略

- **首日必跳**: 无警长模式下必须第一天起跳
- **详细查验**: 提供个性化查验理由
- **位置策略**: 前位积极起跳，后位总结分析
- **可信度建立**: 通过逻辑细节建立可信度

### 女巫策略

- **救人决策**: 严格评估是否救预言家
- **毒杀时机**: 第二夜必须使用毒药
- **身份隐藏**: 延长隐藏时间，关键时刻揭示

### 猎人策略

- **开枪时机**: 夜间死亡时选择最差发言者
- **投票出局**: 根据对跳情况选择开枪目标
- **适度激进**: 无警长保护下可稍微积极

### 村民策略

- **阵营选择**: 第一天必须选择阵营
- **详细推理**: 提供充分的投票理由
- **投票协调**: 防止投票分裂

## 配置与使用

### 环境配置

```bash
# 设置API密钥
export DASHSCOPE_API_KEY="your_api_key_here"

# 可选：设置模型名称
export DASHSCOPE_MODEL_NAME="qwen3-max"
```

### 基本使用

```python
from agent import PlayerAgent

# 创建代理 (自动加载优化配置)
agent = PlayerAgent(name="Player1")

# 在游戏中使用
await agent.observe(game_message)
response = await agent.reply(game_message)
```

### 模型参数说明

代理已针对狼人杀游戏特点进行优化配置：

- **非流式输出**: 更适合深度策略思考，避免流式输出的碎片化
- **temperature=0.7**: 在创造性和一致性之间取得平衡
- **top_p=0.9**: 保持词汇多样性，避免过于机械的回复

### 模型配置优化

系统针对狼人杀游戏特点进行了专门的模型参数调优：

#### 生成参数调优

```python
generate_kwargs={
    "temperature": 0.7,          # 适度创造性，避免过于死板
    "top_p": 0.9,                # 保持词汇多样性
}
```

#### 配置特点

- **stream=False**: 非流式输出更适合深度策略思考
- **temperature=0.7**: 平衡创造性和策略一致性
- **top_p=0.9**: 保持合理的词汇选择范围
- **参数精简**: 移除不支持的参数，避免截断多段落发言

#### 统一配置管理

系统使用 `model_config.py` 进行统一的模型配置管理：

- 支持环境变量配置
- 提供配置验证功能
- 默认使用 qwen3-max 模型

## 安全特性

### 反注入攻击

- **识别假系统消息**: 区分真实主持人和玩家伪造消息
- **规则固定性**: 明确游戏规则不会中途改变
- **攻击转化**: 将检测到的攻击转化为怀疑证据

### 内容安全

- **发言长度限制**: 自动截断超过 2048 字符的发言
- **工具调用控制**: 讨论阶段禁用工具调用
- **状态持久化**: 关键游戏状态自动保存

## 性能优化

### 性能优化

#### 模型配置优化

- **非流式输出**: 采用 stream=False，更适合深度策略思考，避免流式输出的碎片化问题
- **参数调优**: temperature=0.7 和 top_p=0.9 的黄金组合，平衡创造性和策略一致性
- **参数精简**: 移除不支持的参数，避免发言截断，确保多段落策略分析的完整性

#### 状态管理

- 使用 `register_state` 实现状态持久化
- 自动清理过长的历史记录
- 增量更新避免重复计算

#### 响应优化

- 上下文构建减少重复推理
- 策略建议基于当前游戏阶段
- 双语支持提升理解准确性

## 扩展性

### 角色扩展

系统支持轻松添加新角色：

1. 在角色映射中添加新角色
2. 实现对应的策略逻辑
3. 更新系统提示模板

### 策略扩展

- 怀疑度算法可自定义权重
- 投票模式识别规则可调整
- 可信度评估标准可配置

## 故障排除

### 常见问题

1. **API 密钥问题**

   ```bash
   # 检查密钥是否设置
   echo $DASHSCOPE_API_KEY

   # 验证配置
   python -c "from model_config import validate_model_config; validate_model_config()"
   ```

2. **模型响应异常**

   - 检查网络连接
   - 验证模型名称配置 (当前使用 qwen3-max)
   - 查看 API 配额使用情况
   - 确认模型参数配置是否合理

3. **游戏状态异常**

   - 检查消息格式是否符合预期
   - 验证游戏阶段转换逻辑
   - 查看状态持久化是否正常
   - 确认模型输出是否被意外截断

4. **模型参数调优问题**
   - temperature 过高(>0.8): 可能导致策略不一致
   - temperature 过低(<0.3): 可能导致回复过于机械
   - 流式输出问题: 已优化为非流式输出，提升策略思考质量

### 调试建议

- 启用详细日志记录
- 使用游戏历史进行回放分析
- 监控怀疑度变化趋势

## 最佳实践

### 模型配置最佳实践

1. **temperature 调优**: 0.7 是狼人杀游戏的黄金值，平衡创造性和策略一致性
2. **流式输出**: 使用 stream=False，确保完整的策略思考和多段落发言
3. **参数精简**: 避免使用不支持的参数，防止发言被意外截断
4. **模型选择**: qwen3-max 在复杂策略推理方面表现优异

### 游戏策略最佳实践

1. **环境准备**: 确保 API 密钥和模型配置正确
2. **消息格式**: 使用标准的消息格式进行交互
3. **状态监控**: 定期检查代理的游戏状态
4. **策略调优**: 根据游戏结果调整策略参数
5. **安全监控**: 关注异常行为和注入攻击

## 版本信息

- **当前版本**: 1.0.1 (优化模型参数配置)
- **支持模式**: 9 人局无警长
- **模型支持**: DashScope 系列模型 (qwen3-max)
- **框架版本**: AgentScope 最新版
- **更新内容**:
  - 优化 temperature 和 top_p 参数
  - 采用非流式输出提升策略思考质量
  - 精简参数配置，避免发言截断问题

## 联系方式

如有问题或建议，请通过以下方式联系：

- 提交 Issue 到项目仓库
- 查看 AgentScope 官方文档
- 参考示例代码和测试用例

---

_本文档基于最新版本的 PlayerAgent 实现编写，具体功能可能随版本更新而变化。_
